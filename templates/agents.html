{% extends "base.html" %}

{% block title %}Agent{% end %}
{%block nav_container_class%}
class="container-fluid"
{%end%}

{% block script %}
{% end %}
{% block style %}
<style>
    .color-right {
        background-color: yellowgreen;
        color: white;
    }

    .color-wrong {
        color: red;
    }
</style>
{% end %}

{% block navlinks %}
{% end %}

{% block content %}
<div class="container-fluid">
    <div style="margin: 20px;display: flex;justify-content:flex-end;">
        <el-button type="primary" @click="dialogFormVisible = true">添加</el-button>
    </div>

    <el-dialog title="添加Agent" :visible="dialogFormVisible" :before-close="handleClose">
        <el-form ref="form" :model="agent" label-width="100px">
            <el-form-item label="名称" :rules="[{ required: true, message: '不能为空'}]">
                <el-input v-model="agent.name"></el-input>
            </el-form-item>
            <el-form-item label="Agent地址" :rules="[{ required: true, message: '不能为空'}]">
                <el-input v-model="agent.addr"></el-input>
            </el-form-item>
            <el-form-item label="Token" :rules="[{ required: true, message: '不能为空'}]">
                <el-input v-model="agent.token"></el-input>
            </el-form-item>
            <el-form-item label="执行器数量"
                :rules="[{ required: true, message: '不能为空'},{ type: 'number', message: '必须为数字值'}]">
                <el-input v-model="agent.execute_num"></el-input>
            </el-form-item>
            <el-form-item label="描述" :rules="[{ required: true, message: '不能为空'}]">
                <el-input v-model="agent.desc"></el-input>
            </el-form-item>
            <el-form-item label="设备" :rules="[{ required: true, message: '不能为空'}]">
                <el-select style="width: 100%;" v-model="agent.device" placeholder="请选择">
                    <el-option v-for="item in devices" :key="item.udid" :label="item.platform + '::' +  item.udid"
                        :value="item.udid">
                    </el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="启动参数">
                <el-input v-model="agent.launch_params"></el-input>
            </el-form-item>

        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="dialogFormVisible = false">取消</el-button>
            <el-button type="primary" @click="handlerSave">确定</el-button>
        </div>
    </el-dialog>

    <div style="display: flex;flex-wrap: wrap;justify-content:flex-start;width:100%;">
        <el-card class="box-card" v-for="(agent,index) in agents">
            <el-descriptions :title="agent.device" border :column="3">
                <template slot="extra">
                    <el-button type="danger" size="small" @click="deleteAgent(agent)">删除</el-button>
                    <el-button type="primary" size="small" @click="editAgent(agent)">编辑</el-button>
                </template>
                <el-descriptions-item :show-overflow-tooltip='true' class='row' v-for="(v,k) in agent"
                 :label="k">{{! v}}
                </el-descriptions-item>
            </el-descriptions>
        </el-card>
    </div>

</div>
{% end %}

{% block script %}
<style>
    .box-card {
        width: 100%;
        min-width: 400px;
        margin: 20px;
    }

    .row {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
<script>
    $.getJSON("/api/v1/agent")
        .then((ret) => {
            console.log(ret);
            new Vue({
                el: "#app",
                data: Object.assign({
                    dialogFormVisible: false,
                    devices: [],
                    agent: {
                        device: null,
                        name: "默认名称",
                        addr:'http://172.16.246.89:8080/',
                        token: null,
                        execute_num: 1,
                        desc: "描述",
                        launch_params: '{}'
                    },
                    token: "",
                    agents: null,
                }, { "agents": ret.agents }),
                mounted() {
                    this.fetch()
                },
                methods: {
                    handleClose(done) {
                        this.$confirm('是否关闭')
                            .then(_ => {
                                done();
                                this.dialogFormVisible = false;
                            })
                            .catch(_ => { });
                    },
                    editAgent(agent) {
                        console.log(agent);
                        this.agent = agent;
                        this.dialogFormVisible = true;
                    },
                    handlerSave(agent, method) {
                        this.dialogFormVisible = false;

                        $.post("/api/v1/agent", this.agent)
                            .then((ret) => {
                                console.log(ret);
                                const h = this.$createElement;
                                if(ret['success'] === true) {
                                    location.reload()
                                    return 
                                }
                                this.$notify({
                                    title: '错误',
                                    message: ret['msg']
                                  });
                            })
                    },
                    deleteAgent(agent) {
                        console.log(agent)
                        $.ajax({
                            url: "/api/v1/agent",
                            type: 'delete',
                            data: agent,
                            success: function (ret) {
                                console.log(ret);
                            }
                        })
                    },
                    fetch() {
                        $.getJSON("/api/v1/devices")
                            .then((ret) => {
                                console.log(ret)
                                this.devices = ret['devices']
                            })
                    }
                }
            })
        })
</script>
{% end %}